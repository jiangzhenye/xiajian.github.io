---
layout: post
title: Rack杂记
category : rack
---

## 缘起
----

最近，`系统`的学习了一下Rack，收获颇丰。毕竟，全新的概念，从无到有的飞跃。

所谓的系统的学习，其实就是将potian写的[Rack编程](http://www.iteye.com/topic/605707)囫囵吞枣的看了一遍，敲了敲其中的例子，并运行验证了而已。

对于，以后，项目中如何使用，还没个头绪，不过，最要紧的是先收集资料。

## rake middleware

Rails早已支持Rack了，可以通过`rake middleware`查看项目中使用的中间件。于是，作为对比，分别对公司的项目，Gitlab，Redmine运行了一下，从而得出如下列表:

三者通用的Rack中间件: 

```ruby
use ActionDispatch::Static
use Rack::Lock
use Rack::Runtime
use Rack::MethodOverride
use BetterErrors::Middleware # better error居然是Rack中间件，Redmine使用
use ActionDispatch::RequestId
use Rails::Rack::Logger
use ActionDispatch::ShowExceptions
use ActionDispatch::DebugExceptions
use ActionDispatch::RemoteIp
use ActionDispatch::Reloader
use ActionDispatch::Callbacks
use ActiveRecord::ConnectionAdapters::ConnectionManagement
use ActiveRecord::QueryCache
use ActionDispatch::Cookies
use ActionDispatch::Flash
use ActionDispatch::ParamsParser
use Rack::ConditionalGet
use Rack::ETag
use Warden::Manager  # Redmine使用的OpenIdAuthentication授权
```

Redmine特有(Rails 3.2.19): 

```ruby
use #<ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x00000001ca22a8>
use ActionDispatch::Session::CookieStore
use ActionDispatch::Head
use ActionDispatch::BestStandardsSupport
use RequestStore::Middleware
```

Gitlab特有(Rails 4.1.0): 

```ruby
use Rack::MiniProfiler
use Rack::Sendfile
use ActionDispatch::Session::RedisStore
use Rack::Head
use Rack::Attack
use Rack::Cors
use RequestStore::Middleware
```

公司项目特有(Rails 3.2.13):
```
use #<ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x0000000307c8f0>
use ActionDispatch::Session::CookieStore
use Remotipart::Middleware
use ActionDispatch::Head
use ActionDispatch::BestStandardsSupport
use ClientSideValidations::Middleware::Validators # 客户端验证
use MetaRequest::Middlewares::MetaRequestHandler
use MetaRequest::Middlewares::AppRequestHandler
use Rack::Mongoid::Middleware::IdentityMap
use OmniAuth::Strategies::Weibo       # 网站授权相关的Gem包
use OmniAuth::Strategies::QQConnect
use OmniAuth::Strategies::Xiaonei
use OmniAuth::Strategies::LinkedIn
```

对比了一下，可以得出如下的这些经验: 

* Session的存储是通过Rack中间件实现，其存储存在多种方案，CookieStore，RedisStore以及MemcacheStore之类
* Rails不同版本之间处理差异，比如`ActionDispatch::Head`和`Rack::Head`
* 公司项目Rake执行比Gitlab和Redmine项目的要慢很多，why? 是复杂的表加载的关系
* 运行rake命令，需要加载整个应用程序代码
