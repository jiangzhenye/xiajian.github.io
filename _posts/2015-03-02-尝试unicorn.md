---
layout: post
title: 尝试Unicorn
description: "unicorn, ruby web服务器，socket"
---

## 前言

想尝试一下Unicorn，就使用公司最小的项目mobile试了一下，或者使用[wlog](https://github.com/windy/wblog)这个晚上随便找的项目。

## 正文

mobile的项目无从下手，所以，尝试wlog一半成功了。


RAILS_ENV=production rake db:setup
RAILS_ENV=production rake assets:precompile

Nginx的配置文件: 

```
upstream wblog {
  server unix:/tmp/unicorn_wblog.sock fail_timeout=0;
}

server {
  listen 80;
  server_name 192.168.1.239;
  root /home/ruby/wblog/current/public;

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  location ~ ^/(uploads)/  {
    expires max;
    break;
  }

  try_files $uri/index.html $uri @wblog;
  location @wblog {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://wblog;
  }

  error_page 500 502 503 504 /500.html;
  client_max_body_size 20M;
  keepalive_timeout 10;
}
```

unicorn的配置文件:

```
app_path = "/home/ruby/wblog/current"

worker_processes   1
preload_app        true
timeout            180
listen             '/tmp/unicorn_wblog.sock'
user               'ruby', 'ruby'
working_directory  app_path
pid                "#{app_path}/tmp/pids/unicorn_wblog.pid"
stderr_path        "log/unicorn.log"
stdout_path        "log/unicorn.log"

before_fork do |server, worker|
    old_pid = "#{server.config[:pid]}.oldbin"
    if File.exists?(old_pid) && server.pid != old_pid
      begin
        Process.kill("QUIT", File.read(old_pid).to_i)
      rescue Errno::ENOENT, Errno::ESRCH
        # someone else did our job for us
      end
    end
end

after_fork do |server, worker|
end
```

启动unicorn： `unicorn_rails -c /config/unicorn/unicorn.rb -D -E production`

无缝重启: kill -USR2 $(cat tmp/pids/unicorn_wblog.pid)


遇到的问题: 

```
$ rake assets:precompile 
rake aborted!
NameError: uninitialized constant Rack::Cors
```

解决： 启动环境的问题。设置`RAILS_ENV=production`即可。

```
$ RAILS_ENV=production rake db:setup
rake aborted!
Moped::Errors::ConnectionFailure: Could not connect to a primary node for replica set #<Moped::Cluster:97556630 @seeds=[<Moped::Node resolved_address="127.0.1.1:27017">]>
```

解决： mongodb连接的问题，mongodb.conf中配置的是127.0.0.1, 应用程序中连接的是127.0.1.1。在`mongoid.yml`中将localhost修改为127.0.0.1即可。

```
production:
  sessions:
    default:
      database: w_blog_production
      hosts:
        - 127.0.0.1:27017
```

实践初步完成，接下来进行mobile项目改造。

## 后记

原本，就不是特别熟悉unicorn等之类的web应用服务器，搞了一圈。Passegner就不熟悉，还去搞更不熟悉的unicorn，
判断失误了。
