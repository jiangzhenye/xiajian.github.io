---
layout: post
title: 关于Bundler
---

## 前记

从上班的第一天，前辈给我装好了环境(git clone & bundle install)，就开始使用bundle。现在，想要进行深入的了解一下。

## 简介

bundle是Ruby Dependency Management，为Ruby项目提供了简单方便的环境，其可用来追踪和安装所需gems包的精确版本。Bundle带你远离`依赖地狱`。

使用很简单，首先`gem install bundler`，然后编写Gemfile，`bundle install`安装并生成`Gemfile.lock`, 添加文件到版本控制中。

## bundle文档

命令模式: bundle COMMAND [--no-color] [--verbose] [ARGS]

选项: 
    
    --no-color   Prints all output without color
    --verbose    Prints out additional logging information

bundle命令可以简单分为基础命令和工具命令。基础命令包括: install, update, package, exec, config, help; 工具命令包括: check, list, show, outdated, console, open, viz, init, gem, platform, clean。具体介绍如下: 

基础命令: 

* bundle install  安装通过Gemfile或Gemfile.lock指定的gem包
* bundle update   将依赖的gem包更新到最新Update dependencies to their latest versions
* bundle package  将项目所需的gem文件打包到vendor/cache目录
* bundle exec     在当前bundle的环境中执行脚本
* bundle config   为bundler指定并读取配置选项
* bundle help     显示每个命令的帮助的细节

工具命令:

* bundle check    确认应用程序的需求是否已经安装或可获得
* bundle list     显示当前bundle中所有的gem包
* bundle show     显示特定gem包源码的位置
* bundle outdated 显示当前bundle中所有的过时的gem包
* bundle console  在当前的bundle环境中启动一个IRB会话(考虑Rails的控制台)
* bundle open     在编辑器中打开一个已安装的gem
* bundle viz      生成版本依赖关系的可视化表示(需要ruby-graphviz包)
* bundle init     生成一个简单的Gemfile，并将其放在当前目录下
* bundle gem      创建一个简单的gem，特别适合开发时使用bundler
* bundle platform 显示平台兼容性信息
* bundle clean    清除在bunlder中没有使用的gem包

## Gemfile文档

Gemfile是一种描述Ruby程序gem包依赖的格式, 描述了与执行代码相关的gem包依赖。一般放置在项目根目录下，例如，在Rails程序中，Gemfile放置在同Rakefile相同的目录层次下。

Gemfile被看作Ruby代码来求值，其中，存在很多可用的方法来描述gem包的依赖。这一点很重要，Gemfile其实就是Ruby的用来描述版本依赖关系的DSL。

### 全局源(#source)

在Gemfile的顶部，添加包含Rubygems源的地址。

    source "https://rubygems.org"

在bundler 1.7中，可以但不推荐，在Gemfile的顶部，添加多个有效的全局源(每个都必须是有效的Rubygems源码库)。

Sources are checked for gems following the heuristics described in SOURCE PRIORITY. If a gem is found in more than one global source, Bundler will print a warning after installing the gem indicating which source was used, and listing the other sources where the gem is available. A specific source can be selected for gems that need to use a non-standard repository, suppressing this warning, by using the :source option or a source block.

#### 证书(credentials)

Some gem sources require a username and password. Use bundle config to set the username and password for any sources that need it. The command must be run once on each computer that will install the Gemfile, but this keeps the credentials from being stored in plain text in version control.

有些gem源需要用户名和密码，可以使用`bundle config`设置用户名和密码。在需要使用Gemfile安装每台机器上，都要运行该命令，然后保持证书存储在受版本控制的单个文件中。

    bundle config https://gems.example.com/ user:password

对于某些源，可以在Gemfile的源URL中包含证书信息。

    source "https://user:password@gems.example.com"

在源URL中指定的验证要比使用配置的优先级高。

### ruby

If your application requires a specific Ruby version or engine, specify your requirements using the ruby method, with the following arguments. All parameters are OPTIONAL unless otherwise specified.

如果应用程序需要一个特定的Ruby版本或engine，可以使用带有如下参数`ruby`方法来指定。除了版本，其他参数都是可选的。

The version of Ruby that your application requires. If your application requires an alternate Ruby engine, such as JRuby or Rubinius, this should be the Ruby version that the engine is compatible with.

应用程序所需的Ruby版本是必须，如果应用程序需要一个可选的Ruby引擎，比如JRuby或Rubinius，要注意Ruby版本和engine的兼容性。

    ruby "1.9.3"

Each application may specify a Ruby engine. If an engine is specified, an engine version must also be specified.

每个应用程序都可以指定一个Ruby版本。如果指定engine，那么engine的版本也需要被指定，需要注意的是，engine版本必须和Ruby版本想匹配。

    ruby "1.8.7", :engine => "jruby", :engine_version => "1.6.7"

应用程序可能需要指定Ruby的patchlevel(同Ruby开发和发布的版本有关系)。

ruby "2.0.0", :patchlevel => "247"

### gems


指定gem依赖使用gem方法，并带有如下的参数，name, version, require, groups, platforms, source, git, github, path 除了gem名，其他参数都是可选的。

对于每个gem包依赖，列出独立的一行:

    gem "nokogiri"

**版本**: 每个Gem包都会有一个或多个版本指定的语句: 

    gem "nokogiri", ">= 1.4.2"
    gem "RedCloth", ">= 4.1.0", "< 4.2.0"

**require参数**: Each gem MAY specify files that should be used when autorequiring via Bundler.require. You may pass an array with multiple files or true if file you want required has same name as gem or false to prevent any file from being autorequired.

    gem "redis", :require => ["redis/connection/hiredis", "redis"]
    gem "webmock", :require => false
    gem "debugger", :require => true

`require`参数默认被设定为gem包的名字，例如，如下的表述是相同的:

    gem "nokogiri"
    gem "nokogiri", :require => "nokogiri"
    gem "nokogiri", :require => true

**分组(:group或:groups)**: 每个gem包都会指定Each gem MAY specify membership in one or more groups. Any gem that does not specify membership in any group is placed in the default group.
    
    gem "rspec", :group => :test
    gem "wirble", :groups => [:development, :test]

The Bundler runtime allows its two main methods, Bundler.setup and Bundler.require, to limit their impact to particular groups.

    # setup adds gems to Ruby's load path
    Bundler.setup                    # defaults to all groups
    require "bundler/setup"          # same as Bundler.setup
    Bundler.setup(:default)          # only set up the _default_ group
    Bundler.setup(:test)             # only set up the _test_ group (but `not` _default_)
    Bundler.setup(:default, :test)   # set up the _default_ and _test_ groups, but no others

    # require requires all of the gems in the specified groups
    Bundler.require                  # defaults to just the _default_ group
    Bundler.require(:default)        # identical
    Bundler.require(:default, :test) # requires the _default_ and _test_ groups
    Bundler.require(:test)           # requires just the _test_ group

The Bundler CLI allows you to specify a list of groups whose gems bundle install should not install with the --without option. To specify multiple groups to ignore, specify a list of groups separated by spaces.

bundle install --without test
bundle install --without development test

After running bundle install --without test, bundler will remember that you excluded the test group in the last installation. The next time you run bundle install, without any --without option, bundler will recall it.

Also, calling Bundler.setup with no parameters, or calling require "bundler/setup" will setup all groups except for the ones you excluded via --without (since they are obviously not available).

Note that on bundle install, bundler downloads and evaluates all gems, in order to create a single canonical list of all of the required gems and their dependencies. This means that you cannot list different versions of the same gems in different groups. For more details, see Understanding Bundler.
PLATFORMS (:platforms)

If a gem should only be used in a particular platform or set of platforms, you can specify them. Platforms are essentially identical to groups, except that you do not need to use the --without install-time flag to exclude groups of gems for other platforms.

There are a number of Gemfile platforms:

ruby
    C Ruby (MRI) or Rubinius, but NOT Windows
ruby_18
    ruby AND version 1.8
ruby_19
    ruby AND version 1.9
ruby_20
    ruby AND version 2.0
ruby_21
    ruby AND version 2.1
mri
    Same as ruby, but not Rubinius
mri_18
    mri AND version 1.8
mri_19
    mri AND version 1.9
mri_20
    mri AND version 2.0
mri_21
    mri AND version 2.1
rbx
    Same as ruby, but only Rubinius (not MRI)
jruby
    JRuby
mswin
    Windows
mingw
    Windows 32 bit 'mingw32' platform (aka RubyInstaller)
mingw_18
    mingw AND version 1.8
mingw_19
    mingw AND version 1.9
mingw_20
    mingw AND version 2.0
mingw_21
    mingw AND version 2.1
x64_mingw
    Windows 64 bit 'mingw32' platform (aka RubyInstaller x64)
x64_mingw_20
    x64_mingw AND version 2.0
x64_mingw_21
    x64_mingw AND version 2.1

As with groups, you can specify one or more platforms:

gem "weakling",   :platforms => :jruby
gem "ruby-debug", :platforms => :mri_18
gem "nokogiri",   :platforms => [:mri_18, :jruby]

All operations involving groups (bundle install, Bundler.setup, Bundler.require) behave exactly the same as if any groups not matching the current platform were explicitly excluded.
SOURCE (:source)

You can select an alternate Rubygems repository for a gem using the ':source' option.

gem "some_internal_gem", :source => "https://gems.example.com"

This forces the gem to be loaded from this source and ignores any global sources declared at the top level of the file. If the gem does not exist in this source, it will not be installed.

Bundler will search for child dependencies of this gem by first looking in the source selected for the parent, but if they are not found there, it will fall back on global sources using the ordering described in SOURCE PRIORITY.

Selecting a specific source repository this way also suppresses the ambiguous gem warning described above in GLOBAL SOURCES (#source).
GIT (:git)

If necessary, you can specify that a gem is located at a particular git repository. The repository can be public (http://github.com/rails/rails.git) or private (git@github.com:rails/rails.git). If the repository is private, the user that you use to run bundle install MUST have the appropriate keys available in their $HOME/.ssh.

Git repositories are specified using the :git parameter. The group, platforms, and require options are available and behave exactly the same as they would for a normal gem.

gem "rails", :git => "git://github.com/rails/rails.git"

A git repository SHOULD have at least one file, at the root of the directory containing the gem, with the extension .gemspec. This file MUST contain a valid gem specification, as expected by the gem build command.

If a git repository does not have a .gemspec, bundler will attempt to create one, but it will not contain any dependencies, executables, or C extension compilation instructions. As a result, it may fail to properly integrate into your application.

If a git repository does have a .gemspec for the gem you attached it to, a version specifier, if provided, means that the git repository is only valid if the .gemspec specifies a version matching the version specifier. If not, bundler will print a warning.

gem "rails", "2.3.8", :git => "git://github.com/rails/rails.git"
# bundle install will fail, because the .gemspec in the rails
# repository's master branch specifies version 3.0.0

If a git repository does not have a .gemspec for the gem you attached it to, a version specifier MUST be provided. Bundler will use this version in the simple .gemspec it creates.

Git repositories support a number of additional options.

branch, tag, and ref
    You MUST only specify at most one of these options. The default is :branch => "master"
submodules
    Specify :submodules => true to cause bundler to expand any submodules included in the git repository

If a git repository contains multiple .gemspecs, each .gemspec represents a gem located at the same place in the file system as the .gemspec.

|~rails                   [git root]
| |-rails.gemspec         [rails gem located here]
|~actionpack
| |-actionpack.gemspec    [actionpack gem located here]
|~activesupport
| |-activesupport.gemspec [activesupport gem located here]
|...

To install a gem located in a git repository, bundler changes to the directory containing the gemspec, runs gem build name.gemspec and then installs the resulting gem. The gem build command, which comes standard with Rubygems, evaluates the .gemspec in the context of the directory in which it is located.
GITHUB (:github)

If the git repository you want to use is hosted on GitHub and is public, you can use the :github shorthand to specify just the github username and repository name (without the trailing ".git"), separated by a slash. If both the username and repository name are the same, you can omit one.

gem "rails", :github => "rails/rails"
gem "rails", :github => "rails"

Are both equivalent to

gem "rails", :git => "git://github.com/rails/rails.git"

In addition, if you wish to choose a specific branch:

gem "rails", :github => "rails/rails", :branch => "branch_name"

PATH (:path)

You can specify that a gem is located in a particular location on the file system. Relative paths are resolved relative to the directory containing the Gemfile.

Similar to the semantics of the :git option, the :path option requires that the directory in question either contains a .gemspec for the gem, or that you specify an explicit version that bundler should use.

Unlike :git, bundler does not compile C extensions for gems specified as paths.

gem "rails", :path => "vendor/rails"

BLOCK FORM OF SOURCE, GIT, PATH, GROUP and PLATFORMS

The :source, :git, :path, :group, and :platforms options may be applied to a group of gems by using block form.

source "https://gems.example.com" do
  gem "some_internal_gem"
  gem "another_internal_gem"
end

git "git://github.com/rails/rails.git" do
  gem "activesupport"
  gem "actionpack"
end

platforms :ruby do
  gem "ruby-debug"
  gem "sqlite3"
end

group :development do
  gem "wirble"
  gem "faker"
end

In the case of the git block form, the :ref, :branch, :tag, and :submodules options may be passed to the git method, and all gems in the block will inherit those options.
GEMSPEC (#gemspec)

If you wish to use Bundler to help install dependencies for a gem while it is being developed, use the gemspec method to pull in the dependencies listed in the .gemspec file.

The gemspec method adds any runtime dependencies as gem requirements in the default group. It also adds development dependencies as gem requirements in the development group. Finally, it adds a gem requirement on your project (:path => '.'). In conjunction with Bundler.setup, this allows you to require project files in your test code as you would if the project were installed as a gem; you need not manipulate the load path manually or require project files via relative paths.

The gemspec method supports optional :path, :name, and :development_group options, which control where bundler looks for the .gemspec, what named .gemspec it uses (if more than one is present), and which group development dependencies are included in.
SOURCE PRIORITY

When attempting to locate a gem to satisfy a gem requirement, bundler uses the following priority order:

    The source explicitly attached to the gem (using :source, :path, or :git)
    For implicit gems (dependencies of explicit gems), any source, git, or path repository declared on the parent. This results in bundler prioritizing the ActiveSupport gem from the Rails git repository over ones from rubygems.org
    The sources specified via global source lines, searching each source in your Gemfile from last added to first added.

