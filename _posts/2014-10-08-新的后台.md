---
layout: post
title: 关于后台
---

## 缘起
----

觉得以前写的后台不太好用，想要修改，未征得前辈的同意。于是百度了一下，看有没有什么好用Ruby的后台管理的模板之类的，结果找到了两个gem包: web-app-theme和rails_admin

rails_admin有一个Dome, 而web-app-theme没有demo，看来，如果要使用的话，需要去仔细的阅读官方的文档。

rails_admin的Dome的地址为<https://github.com/bbenezech/dummy_app/>，由于年代久远，加之世界变化飞快，很多demo中的很多的gem包的都已经更新到Rails 4或者Ruby 2.0以上了。为了确保以后整合的方便，特地将Gem包之流的版本向前调整了，调整的gem版本如下:

    gem 'rails'
    gem 'rails_admin', '~> 0.4.9'
    gem 'cancan'
    gem 'devise'
    gem 'paperclip'
    gem 'mini_magick'
    gem 'carrierwave'
    gem 'dragonfly', '0.9.12'

> 精确的版本控制是很重要的，版本的不兼容会导致很多的问题，而且莫名其妙。比如dragonfly 0.9和 1.0之间的不兼容，导致自己安装和启动服务器不能成功。

此外，原先的gem包的安装在工作使用的tophold的gemset中，导致安装了一大堆的不同版本的Rails，相当的混乱。使用`rvm gemset empty tophold`将gemset清空掉了，然后在重新使用bundle install安装web项目所需的gem; 新建一个新的gemset： cpanel。并尝试在项目中添加`.ruby-gemset`和`.ruby-version`，仔细想想，这样也挺方便的，不必时时都用默认的。

成功运行Demo之后，界面还挺漂亮的，效果也挺不错的，没有出现全面刷新的情况。查看了一下代码，傻眼了，除了Models中有些内容，其他的地方都没什么内容，难道，具体的内容都封装到了rails_amdin中。但是，如何使用过去版本的rails_admin，从哪里下手，一脸迷茫，先从项目的Readme开始。

## RailsAdmin
----

RailsAdmin是一个Rails engine，其提供易于使用的接口操作数据。

### 特性

RailsAdmin具有很多的特性，其中一些列出如下:

* 可对任何数据进行CRUD操作
* Custon定制化方法
* 自动的表单验证
* 搜索以及过滤
* 可将数据导出为CSV/JSON/XML
* 验证通过Devise或其他
* 授权通过Cancan
* 用户动作历史通过PaperTrail
* 支持的ORMs: ActiveRecord以及Mongoid

### 安装

* bundle gem包
* 运行`rails g rails_admin:install`
* 需要时，为路由提供一个命令空间
* 启动服务器，rails s，并在admin/下管理数据。

### 配置

配置文件在`config/initializers/rails_admin`，为了开始需要对启动Devise、Cancan以及Papertrail有所了解。

Rails_admin的wiki文档: <https://github.com/sferik/rails_admin/wiki>

## Cancan
----

CanCan是Ruby的授权库，其限制了给定的用户可以访问的资源。所有的权限都定义在Ability这个类中，并且不需要在控制器，视图以及数据库查询中重复。

### 安装

Rails 3中，通过在Gemfile中添加，并运行bundle命令安装`cancan`。

> gem "cancan"

### 开始

CanCan需要一个可在控制器中访问的`current_user`方法。首先，设置权限(通过[Authlogic](https://github.com/binarylogic/authlogic)或者[Devise](https://github.com/plataformatec/devise))。如果想要特别的定制的话，参考改变[默认行为](https://github.com/ryanb/cancan/wiki/changing-defaults)。

> 注意： 权限和授权是不同的，因此，存在Devise这样的身份验证的权限库，以及cancan这样的授权库。不过，授权本身依赖权限的控制。

**1. 定义Abilities**

用户权限定义在Ability类中，CanCan 1.5提供一个Rails 3的生成器，可以用来创建该类。

如果使用的Rails 2.3的版本，需要在models目录下添加新类ability.rb，并加上如下的内容: 

{% highlight ruby %}
class Ability
  include CanCan::Ability

  def initialize(user)
  end
end
{% endhighlight %}

更多细节参[定义Abilities](https://github.com/ryanb/cancan/wiki/defining-abilities)。

**2.检查Abilities以及Authorization **

当前的用户权限可通过在视图和控制器中使用`can?`和`cannot?`方法检查。

    <% if can? :update, @article %>
      <%= link_to "Edit", edit_article_path(@article) %>
    <% end %>

更多信息参考[Checking Abilities](https://github.com/ryanb/cancan/wiki/checking-abilities)

如果用户不具有操作某个给定工作的权限，`authorize!`方法将会抛出异常。

    def show
      @article = Article.find(params[:id])
      authorize! :read, @article
    end

为每个动作设定如上的anagram是繁琐的，所以`load_and_authorize_resource`方法为所有RESTful的资源路由器的控制器自动设置权限方法。其使用before过滤器在实例变量中加载资源并对每个方法完成授权。

    class ArticlesController < ApplicationController
      load_and_authorize_resource
    
      def show
        # @article is already loaded and authorized
      end
    end

更多信息参考[授权控制器动作](https://github.com/ryanb/cancan/wiki/authorizing-controller-actions)。

**3. Handle Unauthorized Access**

如果用户授权失败，就会抛出`CanCan::AccessDenied`异常。必须要捕获该行为，并在`ApplicationController`中修改其行为。

    class ApplicationController < ActionController::Base
      rescue_from CanCan::AccessDenied do |exception|
        redirect_to root_url, :alert => exception.message
      end
    end
更多信息参考[异常处理](https://github.com/ryanb/cancan/wiki/exception-handling)。

**4. Lock It Down**

如果想要对应用中每一个动作确保授权都能启动，可以同在ApplicationController中添加`check_authorization`。

    class ApplicationController < ActionController::Base
      check_authorization
    end

This will raise an exception if authorization is not performed in an action. If you want to skip this add skip_authorization_check to a controller subclass. See Ensure Authorization for more information.

设置该方法后，如果某个方法没有执行授权，就会抛出异常。如果想要在某个子类中跳过检查，可以在类中添加`skip_authorization_check`。更多信息，参考[Ensure Authorization](https://github.com/ryanb/cancan/wiki/Ensure-Authorization)。

CanCan的Wiki文档: <https://github.com/ryanb/cancan/wiki>

## web-app-theme
----


 


