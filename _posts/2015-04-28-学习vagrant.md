---
layout: post
title: "学习vagrant"
description: "vagrant, 虚拟机，构建一致的开发环境，ruby"
---

## 前言

最早的时候，是在某学弟的说说中看到vagrant。github上搜了一下，发现star数还挺多的。随后的岁月里，常常能看到这个名词，今天研究一下。

## 安装

先决条件： 安装virtualbox。

安装使用installer，用RubyGems安装问题多多，依赖巨复杂。

vagrant其实就是封装了的Virtualbox的API的ruby DSL，抽象和简化了某些操作，用一个命令，而不是一堆命令去管理和使用vm。

## 使用

首先，创建一个新的目录(`mkdir test`)，然后cd到该目录中去。

```
vagrant box add base http://files.vagrantup.com/lucid32.box  # 这里的模式是 vagrant box add {title} {url}
vagrant init base # 如果添加了一个box，加不加base，没有区别
vagrant up
vagrant ssh
```

vagrant最强大灵活的就是镜像，一些镜像的地址是: <http://www.vagrantbox.es/>

若是从<http://www.vagrantbox.es/>直接下载镜像，则需要运行如下的命令: 

```
vagrant init ubuntu-14.04.box  # ubuntu-14.04.box为已下载的某镜像文件
vagrant up
vagrant ssh

```

> 备注： 起初看到启动vm时，可以通过ssh进行连接的，`ssh vagrant@127.0.0.1:2200` ，一直timeout。看了官方文档后，才知道原来使用`vagrant ssh`命令

启动和停止虚拟机: 

```
vagrant up     #开机
vagrant halt   #关机
vagrant reload #重新启动，主要用于重新载入配置文件
```

剩下的大部分需要的学习的部分都在了解如何配置Vagrantfile文件。

## virtualbox

虚拟化的好处: 

* 可同时运行多个操作系统
* 软件安装更容易 - 将复杂的步骤打包到虚拟机中
* 测试和容灾恢复 - 快照功能、保存虚拟机特定状态，云主机有自动打快照的功能
* 基础设施的整合 - 充分利用物理机器的性能

**术语**: Host OS, Guest OS(支持任何X86的系统), 虚拟机(VirtualBox为 Guest OS 创建的特定环境，VirtualBox默认将虚拟机看作一组参数 - 决定了虚拟机的行为), 客机增强件(安装在虚拟机中，提高客机性能和额外的功能支持)

Virtualbox的功能概览: 

* 可移植性，2类虚拟机管理程序，相对直接运行在裸机上虚拟机。开放虚拟化格式OVF。
* 硬件虚拟化不是必备条件 - 处理器可支持虚拟化技术
* 客机增强套件： 共享文件夹，无缝窗口，3D虚拟化。
* 硬件支持: SMP,USB, 硬件兼容性，PXE等
* 多代可分支快照
* 架构整洁、结构模块化，存在SDK接口 - vagrant所依赖的
* 远程桌面显示: VRDE之类

VirtualBox 提供了不少命令行工具: 

1. **VBox**
1. **VBoxAutostart**
1. **VBoxBalloonCtrl**
1. **VBoxHeadless**
1. **VBoxManage** 是 Virtualbox 的命令行接口，其支持比图形界面更多的功能，可展现虚拟引擎的所有功能。
1. **VBoxSDL**
1. **VBoxTunctl**
1. **VBoxVRDP**

> 备注: 上面的这些命令也存在小写字母版的，果然，要大写什么的，太不方便的。

需要编译并加载vboxdrv内核模块，VirtualBox应用程序通过Unix本地套接字与后台程序通信。

两种镜像文件: 动态扩展的镜像文件、固定大小镜像文件。

更多相关技术，可以参考VirtualBox提供的相关的文档: <https://www.virtualbox.org/wiki/Documentation>

虚拟化相关的技术: XEN, KVM(OpenStack利用)，Hypervisor，基于LXC的Docker。虚拟化的技术，需要对OS的理解加深。

## 后记

原本是为了装qq，才去装virtualbox和XP的镜像系统，结果用了一段时间后，发现体验和感觉都相当的不错。这让我意识到虚拟环境的有用和高效之处。

阅读了一下Virtualbox的文档之后，发现Virtualbox有提供API和SDK的接口。这样就很好理解vagrant的开发的基础。此外，偶然发现，vagrant的作者在11年的时候，曾开发过一个[virtualbox](https://github.com/mitchellh/virtualbox)的gem。 此外，Virtualbox本身以依赖其他的一些GNU的虚拟机的代码，比如bochs。

这段意思是，没有凭空而来的成功，所有的软件都有其基础和对应解决的问题。

## 参考文献

1. [vagrant使用小结](http://www.cnblogs.com/fuyunbiyi/archive/2013/01/13/2858447.html)
2. [Vagrant小结](http://www.douban.com/note/322249262/)
3. [Vagrant官方](https://www.vagrantup.com/)
4. [VirtualBox用户手册](http://wenku.baidu.com/link?url=JlB4ctpYf6caclrAHdo8VMC0MO0-MVCX8Fa68lPDJddDt0FFNoaBGANO1c3F9h-oGBp1_oHlve09VHApnlX3BydItLvuWPnRWHXj4rjd2-_)
