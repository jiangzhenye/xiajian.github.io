---
layout: post
title: "学习vagrant"
description: "vagrant, 虚拟机，构建一致的开发环境，ruby"
---

## 前言

最早的时候，是在某学弟的说说中看到vagrant。github上搜了一下，发现star数还挺多的。随后的岁月里，常常能看到这个名词，今天研究一下。

## 安装

先决条件： 安装[virtualbox](https://www.virtualbox.org/) - 安装的virtualbox版本为`4.3.20r96996`(vboxmanage -v)。

安装使用installer，用RubyGems安装问题多多，依赖巨复杂，vagrant安装的版本是 1.7.2 (vagrant version)

vagrant其实就是封装了的Virtualbox的API的ruby DSL，抽象和简化了某些操作，用一个命令以及配置文件，而不是一堆命令去管理和使用vm。

## 使用

首先，创建一个新的目录(`mkdir test`)，然后cd到该目录中去。

```
vagrant box add base http://files.vagrantup.com/lucid32.box  # 这里的模式是 vagrant box add {title} {url}
vagrant init base # 如果添加了一个box，加不加base，没有区别
vagrant up
vagrant ssh
```

vagrant最强大灵活的就是镜像，一些镜像的地址是: <http://www.vagrantbox.es/>

若是从<http://www.vagrantbox.es/>直接下载镜像，则需要运行如下的命令: 

```
vagrant init ubuntu-14.04.box  # ubuntu-14.04.box为已下载的某镜像文件
vagrant up
vagrant ssh
```

> 备注： 起初看到启动vm时，可以通过ssh进行连接的，`ssh vagrant@127.0.0.1:2200` ，一直timeout。看了官方文档后，才知道原来使用`vagrant ssh`命令

其他的一些vagrant操作的命令: 

```
vagrant up       # 开机
vagrant halt     # 关机
vagrant reload   # 重新启动，主要用于重新载入配置文件
vagrant suspend  # 挂起当前虚拟机
vagrant resume   # 恢复被挂起的vm状态
vagrant box list # 列出所有box列表
vagrant box remove {basename}
vagrant destroy  # 停止当前正在运行的虚拟机并销毁所有创建的资源
vagrant package  # 把当前的运行的虚拟机环境进行打包，可用于分发开发环境
vagrant plugin   # 安装卸载插件 
vagrant provision  # 设置基本的环境，进一步设置可以使用Chef/Puppet进行搭建
vagrant ssh-config # 输出ssh连接的一些信息
vagrant status     # 获取虚拟机状态
vagrant version    # 获取vagrant的版本
```

除了上面的那些命令，还有 login 、rdp 、 share 、global-status等等，详细参考 `vagrant -h`。

剩下的大部分需要的学习的部分都在了解如何配置Vagrantfile文件。

vagrant的用处: 单机模拟多台机器，从而测试分布式的集群环境。Vagrantfile中可以定义vm的角色，也可`vagrant ssh {role-name}`到特定的机器上去。

## vagrant的相关配置

vagrantfile相关的配置涉及 vm 、 ssh 、 winrm 、vagrant、 box 、network、同步目录，多机器配置，虚拟技术提供方，插件(似乎提供不少插件)以及推送(Push)。

简单的配置介绍如下: 

```
config.vm.box = "base"      # vm的box的基，默认为base
config.vm.customize ["modifyvm", :id, "--name", "gogojimmy", "--memory", "512"]  # 配置vm的各种参数
config.vm.host_name = "xxx" # 配置主机名，很重要的标识
config.vm.network           # 两种桥接方式，私有和公共          
```

最为强大的是多虚拟机的系统设置，只需在同一`Vagrantfile`中定义不同的用户角色即可: 

```
config.vm.define :app do |app_config|
  app_config.vm.host_name = "app"
  app_config.vm.network "private_network", ip: "33.33.13.10"
end

config.vm.define :db do |db_config|
  db_config.vm.host_name = "db"
  db_config.vm.network "private_network", ip: "33.33.13.11"
  db_config.vm.provider "virtualbox" do |vb|
    vb.memory = "512"
  end
end

config.vm.define :cache do |cache_config|
  cache_config.vm.host_name = "cache"
  cache_config.vm.network "private_network", ip: "33.33.13.12"
end
```

通过上面的配置，然后运行`vagrant up`，分分钟就可以启动3台虚拟机了。具体输出如下: 

```
Bringing machine 'app' up with 'virtualbox' provider...
Bringing machine 'db' up with 'virtualbox' provider...
Bringing machine 'cache' up with 'virtualbox' provider...
==> app: Clearing any previously set forwarded ports...
==> app: Fixed port collision for 22 => 2222. Now on port 2200.
==> app: Clearing any previously set network interfaces...
==> app: Preparing network interfaces based on configuration...
    app: Adapter 1: nat
    app: Adapter 2: hostonly
==> app: Forwarding ports...
    app: 22 => 2200 (adapter 1)
==> app: Booting VM...
==> app: Waiting for machine to boot. This may take a few minutes...
    app: SSH address: 127.0.0.1:2200
    app: SSH username: vagrant
    app: SSH auth method: private key
    app: Warning: Connection timeout. Retrying...
==> app: Machine booted and ready!
==> app: Checking for guest additions in VM...
    app: The guest additions on this VM do not match the installed version of
    app: VirtualBox! In most cases this is fine, but in rare cases it can
    app: prevent things such as shared folders from working properly. If you see
    app: shared folder errors, please make sure the guest additions within the
    app: virtual machine match the version of VirtualBox you have installed on
    app: your host and reload your VM.
    app: 
    app: Guest Additions Version: 4.2.0
    app: VirtualBox Version: 4.3
==> app: Setting hostname...
==> app: Configuring and enabling network interfaces...
==> app: Mounting shared folders...
    app: /vagrant => /home/xiajian/works/test/vargant
==> app: Machine already provisioned. Run `vagrant provision` or use the `--provision`
==> app: to force provisioning. Provisioners marked to run always will still run.
  。。省略DB和Cache的启动。。。
```

> 备注: 不同版本的vagrant之间的配置可能有所区别，具体的以当前生成的Vagrantfile中配置描述的为准。
> `vagrant reload`只能对已有的虚拟机进行配置的重新载入，对于未创建的虚拟机则不作处理。所以，虚拟机的启动，
> 主要还是靠`vagrant up`命令。

此外，virtualbox仅仅是vagrant的一个虚拟机提供商，Docker和VMWare也是vagrant的provider。

vagrant文档提供了翔实的信息，更多可参考<https://docs.vagrantup.com/v2/> 。


## virtualbox

虚拟化的好处: 

* 可同时运行多个操作系统
* 软件安装更容易 - 将复杂的步骤打包到虚拟机中
* 测试和容灾恢复 - 快照功能、保存虚拟机特定状态，云主机有自动打快照的功能
* 基础设施的整合 - 充分利用物理机器的性能

**术语**: Host OS(宿主os), Guest OS(支持任何X86的系统), 虚拟机(VirtualBox为 Guest OS 创建的特定环境，VirtualBox默认将虚拟机看作一组参数 - 决定了虚拟机的行为), 客机增强件(安装在虚拟机中，提高客机性能和额外的功能支持)

Virtualbox的功能概览: 

* 可移植性，2类虚拟机管理程序，相对直接运行在裸机上虚拟机(一类vm mangement)。开放虚拟化格式OVF。
* 硬件虚拟化不是必备条件 - 处理器可支持虚拟化技术
* 客机增强套件： 共享文件夹，无缝窗口，3D虚拟化。
* 硬件支持: SMP,USB, 硬件兼容性，PXE等
* 多代可分支快照
* 架构整洁、结构模块化，存在SDK接口 - vagrant所依赖的
* 远程桌面显示: VRDE之类

VirtualBox 提供了不少命令行工具: 

1. **VBox**
1. **VBoxAutostart**
1. **VBoxBalloonCtrl**
1. **VBoxHeadless**
1. **VBoxManage** 是 Virtualbox 的命令行接口，其支持比图形界面更多的功能，可展现虚拟引擎的所有功能。
1. **VBoxSDL**
1. **VBoxTunctl**
1. **VBoxVRDP**

> 备注: 上面的这些命令也存在小写字母版的，果然，要大写什么的，太不方便了。

需要编译并加载vboxdrv内核模块，VirtualBox应用程序通过Unix本地套接字与后台程序通信。

两种镜像文件: 动态扩展的镜像文件、固定大小镜像文件。

更多相关技术，可以参考VirtualBox提供的相关的文档: <https://www.virtualbox.org/wiki/Documentation>

虚拟化相关的技术: XEN, KVM(OpenStack利用)，Hypervisor，基于LXC的Docker。虚拟化的技术，需要对OS的理解加深。

## 后记

原本是为了装qq，才去装virtualbox和XP的镜像系统，结果用了一段时间后，发现体验和感觉都相当的不错。这让我意识到虚拟环境的有用和高效之处。

阅读了一下Virtualbox的文档之后，发现Virtualbox有提供API和SDK的接口。这样就很好理解vagrant的开发的基础。此外，偶然发现，vagrant的作者在11年的时候，曾开发过一个[virtualbox](https://github.com/mitchellh/virtualbox)的gem。 此外，Virtualbox本身以依赖其他的一些GNU的虚拟机的代码，比如bochs。

这段意思是，没有凭空而来的成功，所有的软件都有其基础和对应解决的问题。

怎么把Vagrant， Chef， Docker， Capistrano 这些坑爹的玩意整合到一个workflow中，这是我今后要面对的问题。

## 参考文献

1. [vagrant使用小结](http://www.cnblogs.com/fuyunbiyi/archive/2013/01/13/2858447.html)
2. [Vagrant小结](http://www.douban.com/note/322249262/)
3. [Vagrant官方](https://www.vagrantup.com/)
4. [VirtualBox用户手册](http://wenku.baidu.com/link?url=JlB4ctpYf6caclrAHdo8VMC0MO0-MVCX8Fa68lPDJddDt0FFNoaBGANO1c3F9h-oGBp1_oHlve09VHApnlX3BydItLvuWPnRWHXj4rjd2-_)
5. [Vgrant使用入门](https://github.com/astaxie/Go-in-Action/blob/master/ebook/zh/01.3.md)
6. [使用Vagrant練習環境佈署](http://gogojimmy.net/2013/05/26/vagrant-tutorial/)
