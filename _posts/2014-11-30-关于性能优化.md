---
layout: post
title: 关于性能优化
---

## 前言

网站慢，全栈式programmer等的动机下，我涉足了性能优化的领域。其实，我对Rails、服务器设置、mysql等方面都不是很了解，就贸然进行所谓的性能优化。结果，只做到css置顶js置低这一条，其他的，目前都不再掌控范围内。在这期间，倒是买了些本书。

* 《web性能权威指南》，这本书名翻译的有问题，英文名是《High Proformance Browser Networking》。讨论的都是底层原理部分，TCP，HTTP，XHR，websocket之类，适合心静下来时看看
* 《HTTP权威指南》，相当不错的书，对web基本协议HTTP的讲解非常的深刻，涉及内容多且深
* 《构建高性能web站点》，国人出品的书，就涵盖的性能优化方面而言，有一定的广度和实践性
* 《JavaScript性能优化》，不厚，关注实践和方法论，很不错的书
* 《web站点优化》，两方面入手，SEO/SEM和站点优化，角度很新颖，就是没时间细看

看书是我主要的学习方式，光看书不实践是不行的。性能中，最重要的是度量，度量就必须要有相应的工具和方法。

## 黑盒测试工具

ab, httpref以及autobench。其中，直接可用的工具为ab，以下，以本地测试的环境，使用ab进行测试。

测试测试服务器的网站: ab -n1000 -c10 http://redmine.tophold.com/

```
Server Software:        nginx/1.6.1
Server Hostname:        redmine.tophold.com
Server Port:            80

Document Path:          /
Document Length:        2808 bytes

Concurrency Level:      10
Time taken for tests:   11.304 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      3516000 bytes
HTML transferred:       2808000 bytes
Requests per second:    88.46 [#/sec] (mean)
Time per request:       113.041 [ms] (mean)
Time per request:       11.304 [ms] (mean, across all concurrent requests)
Transfer rate:          303.75 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.1      0       1
Processing:    23  112  73.0     98    1389
Waiting:       23  111  73.1     98    1389
Total:         23  113  73.0     98    1389

Percentage of the requests served within a certain time (ms)
  50%     98
  66%    130
  75%    145
  80%    146
  90%    150
  95%    165
  98%    218
  99%    233
 100%   1389 (longest request)
```

注： 在运行服务器的本地进行测试，发现，1000请求/1.52秒

测试测试服务器的网站:ab -n1000 -c10  http://staging.tophold.com/

```
Server Software:        nginx/1.6.1
Server Hostname:        staging.tophold.com
Server Port:            80

Document Path:          /
Document Length:        45142 bytes

Concurrency Level:      10
Time taken for tests:   81.822 seconds
Complete requests:      1000
Failed requests:        999
   (Connect: 0, Receive: 0, Length: 999, Exceptions: 0)
Total transferred:      45472198 bytes
HTML transferred:       44937923 bytes
Requests per second:    12.22 [#/sec] (mean)
Time per request:       818.225 [ms] (mean)
Time per request:       81.822 [ms] (mean, across all concurrent requests)
Transfer rate:          542.72 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.6      0       6
Processing:   276  816 437.9    659    4055
Waiting:      272  811 437.8    656    4051
Total:        276  816 437.9    661    4055

Percentage of the requests served within a certain time (ms)
  50%    661
  66%    776
  75%   1298
  80%   1359
  90%   1440
  95%   1456
  98%   1496
  99%   1963
 100%   4055 (longest request) 
```

测试本地开发: ab -n1000 -c10  http://0.0.0.0:3000/

```
Server Software:        thin
Server Hostname:        0.0.0.0
Server Port:            3000

Document Path:          /
Document Length:        48932 bytes

Concurrency Level:      10
Time taken for tests:   504.689 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      49373000 bytes
HTML transferred:       48932000 bytes
Requests per second:    1.98 [#/sec] (mean)
Time per request:       5046.888 [ms] (mean)
Time per request:       504.689 [ms] (mean, across all concurrent requests)
Transfer rate:          95.54 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.1      0       1
Processing:  1028 5038 1094.5   5010    9119
Waiting:      885 4158 917.9   4416    5504
Total:       1028 5039 1094.5   5011    9119

Percentage of the requests served within a certain time (ms)
  50%   5011
  66%   5114
  75%   5164
  80%   5283
  90%   6635
  95%   7390
  98%   8188
  99%   8492
 100%   9119 (longest request)
```

注: 请求低于5 req/s，确实存在一定的问题，但是，如何进行优化。

## 日志分析工具

Request-log-analyzer


